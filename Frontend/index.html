<!DOCTYPE html>
<html lang="es">

<!-- Localidades, enfermedades, enfermedades mascotas, facturación no actualiza, inserta, no sé por qué, ya cambié el id de resto funciona -->
<!-- La página de tratamientos no está mostrando nada -->
<!-- Duplicar el mismo comportamiento de Mascota al añadir un cliente (Te muestra la lista de los clientes pero inserta el id) -->
<!-- Para los veterinarios hacer que por defecto me muestre todos llos valores a la hora de actualizar -->
<!-- Probar que cada servicio arroje error en caso de que se inserte algo que ya existe. ejemplo un cliente con el mismo teléfono, correo o datos que no deban duplicarse-->
<!-- Añadir tema de logueo -->


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veterinaria Wapoki</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        // --- Importa funciones de React para manejar datos y actualizaciones.
        const { useState, useEffect, useCallback } = React;
        const API_URL = 'http://localhost:4000/api';

        //-----------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------

        // ----------------------------
        // MODAL PARA MASCOTAS ✔
        // ----------------------------

        const PetModal = ({ pet, clients, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                nombre: pet?.nombre || '',
                especie: pet?.especie || '',
                raza: pet?.raza || '',
                edad: pet?.edad || '',
                peso: pet?.peso || '',
                id_cliente: pet?.id_cliente || ''
            });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = pet?.id_mascota
                    ? { ...formData, id_mascota: pet.id_mascota }
                    : formData;
                onSave(dataToSave);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{pet ? 'Editar Mascota' : 'Añadir Nueva Mascota'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} placeholder="Nombre de la mascota" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <select name="especie" value={formData.especie} onChange={handleChange} className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none bg-white">
                                    <option value="" disabled> Especie </option>
                                    <option value="Perro">Perro</option>
                                    <option value="Gato">Gato</option>
                                    <option value="Ave">Ave</option>
                                    <option value="Reptil">Reptil</option>
                                    <option value="Otro">Otro</option>
                                </select>
                                <input type="text" name="raza" value={formData.raza} onChange={handleChange} placeholder="Raza" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <input type="number" name="edad" value={formData.edad} onChange={handleChange} placeholder="Edad" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <input type="number" step="0.01" name="peso" value={formData.peso} onChange={handleChange} placeholder="Peso (kg)" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <select name="id_cliente" value={formData.id_cliente} onChange={handleChange} className="p-3 border rounded-lg md:col-span-2 focus:ring-2 focus:ring-orange-400 focus:outline-none bg-white" required>
                                    <option value="" disabled> Seleccione un Dueño </option>
                                    {clients.map(client => (
                                        <option key={client.id_cliente} value={client.id_cliente}>
                                            {client.nombre} {client.apellido}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE MASCOTAS ✔
        // ---------------------------------

        const PetsPage = ({ data, onSave, onDelete }) => {
            const { pets, clients } = data;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingPet, setEditingPet] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const filteredPets = pets.filter(pet => Object.values(pet).some(value => String(value).toLowerCase().includes(searchTerm.toLowerCase())));
            return (
                <div>
                    {isModalOpen && <PetModal pet={editingPet} clients={clients} onClose={() => { setIsModalOpen(false); setEditingPet(null); }} onSave={onSave} />}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Panel de Gestión de Mascotas</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" placeholder="Buscar mascota, dueño..." className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            </div>
                            <button onClick={() => { setEditingPet(null); setIsModalOpen(true); }} className="w-full md:w-auto bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition-colors flex items-center justify-center space-x-2">
                                <i className="fas fa-plus"></i>
                                <span>Añadir Mascota</span>
                            </button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-4 font-semibold text-gray-600">Mascota</th>
                                        <th className="p-4 font-semibold text-gray-600">Especie</th>
                                        <th className="p-4 font-semibold text-gray-600">Dueño</th>
                                        <th className="p-4 font-semibold text-gray-600 text-center">Peso (kg)</th>
                                        <th className="p-4 font-semibold text-gray-600 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredPets.map(pet => (
                                        <tr key={pet.id_mascota} className="border-b hover:bg-gray-50">
                                            <td className="p-4">
                                                <div className="font-semibold text-gray-800">{pet.nombre}</div>
                                                <div className="text-sm text-gray-500">{pet.raza} - {pet.edad} años</div>
                                            </td>
                                            <td className="p-4 text-gray-700">{pet.especie}</td>
                                            <td className="p-4 text-gray-700">{pet.nombre_cliente}</td>
                                            <td className="p-4 text-gray-700 text-center">{pet.peso}</td>
                                            <td className="p-4 text-center">
                                                <button onClick={() => { setEditingPet(pet); setIsModalOpen(true); }} className="text-blue-500 hover:text-blue-700 p-2" title="Editar">
                                                    <i className="fas fa-edit fa-lg"></i>
                                                </button>
                                                <button onClick={() => onDelete(pet.id_mascota)} className="text-red-500 hover:text-red-700 p-2" title="Eliminar">
                                                    <i className="fas fa-trash-alt fa-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredPets.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-paw fa-3x mb-4"></i>
                                <p className="font-semibold">No se encontraron mascotas</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ----------------------------
        // MODAL PARA CLIENTES ✔
        // ----------------------------

        const ClientModal = ({ client, onClose, onSave }) => {
            const [formData, setFormData] = useState(client ||
            {
                nombre: '',
                apellido: '',
                telefono: '',
                email: '',
                direccion: '',
                id_barrio: ''
            });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = client?.id_cliente
                    ? { ...formData, id_cliente: client.id_cliente }
                    : formData;
                onSave(dataToSave);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{client ? 'Editar Cliente' : 'Añadir Nuevo Cliente'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} placeholder="Nombre" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <input type="text" name="apellido" value={formData.apellido} onChange={handleChange} placeholder="Apellido" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <input type="tel" name="telefono" value={formData.telefono} onChange={handleChange} placeholder="Teléfono" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" />
                                <input type="email" name="email" value={formData.email} onChange={handleChange} placeholder="Email" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" />
                                <input type="text" name="direccion" value={formData.direccion} onChange={handleChange} placeholder="Dirección" className="p-3 border rounded-lg md:col-span-2 focus:ring-2 focus:ring-orange-400 focus:outline-none" />
                                <input type="number" name="id_barrio" value={formData.id_barrio} onChange={handleChange} placeholder="Barrio" className="p-3 border rounded-lg md:col-span-2 focus:ring-2 focus:ring-orange-400 focus:outline-none" />
                            </div>
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE CLIENTES ✔
        // ---------------------------------

        const ClientsPage = ({ data, onSave, onDelete }) => {
            const { clients } = data;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingClient, setEditingClient] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const filteredClients = clients.filter(client =>
                Object.values(client).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );
            return (
                <div>
                    {isModalOpen &&
                        <ClientModal
                            client={editingClient}
                            onClose={() => { setIsModalOpen(false); setEditingClient(null); }}
                            onSave={onSave}
                        />
                    }
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Panel de Gestión de Clientes</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" placeholder="Buscar por nombre, email, teléfono..." className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            </div>
                            <button onClick={() => { setEditingClient(null); setIsModalOpen(true); }} className="w-full md:w-auto bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition-colors flex items-center justify-center space-x-2">
                                <i className="fas fa-plus"></i>
                                <span>Añadir Cliente</span>
                            </button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-4 font-semibold text-gray-600">Nombre</th>
                                        <th className="p-4 font-semibold text-gray-600">Contacto</th>
                                        <th className="p-4 font-semibold text-gray-600">Dirección</th>
                                        <th className="p-4 font-semibold text-gray-600 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredClients.map(client => (
                                        <tr key={client.id_cliente} className="border-b hover:bg-gray-50">
                                            <td className="p-4">
                                                <div className="font-semibold text-gray-800">{client.nombre} {client.apellido}</div>
                                            </td>
                                            <td className="p-4">
                                                <div className="text-sm text-gray-700">{client.email}</div>
                                                <div className="text-sm text-gray-500">{client.telefono}</div>
                                            </td>
                                            <td className="p-4 text-gray-700">{client.direccion}</td>
                                            <td className="p-4 text-center">
                                                <button
                                                    onClick={() => { setEditingClient(client); setIsModalOpen(true); }}
                                                    className="text-blue-500 hover:text-blue-700 p-2"
                                                    title="Editar"
                                                >
                                                    <i className="fas fa-edit fa-lg"></i>
                                                </button>
                                                <button
                                                    onClick={() => onDelete(client.id_cliente)}
                                                    className="text-red-500 hover:text-red-700 p-2"
                                                    title="Eliminar"
                                                >
                                                    <i className="fas fa-trash-alt fa-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredClients.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-users fa-3x mb-4"></i>
                                <p className="font-semibold">No se encontraron clientes</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ----------------------------
        // MODAL PARA USUARIOS
        // ----------------------------

        const UserModal = ({ user, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                nombre_usuario: user?.nombre_usuario || '',
                contrasenia: user?.nombre_usuario || '', // Por seguridad, no se muestra la contraseña actual
                nombre: user?.nombre || '',
                apellido: user?.apellido || '',
                email: user?.email || '',
                telefono: user?.telefono || '',
                rol: user?.rol || ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = user?.id_usuario
                    ? { ...formData, id_usuario: user.id_usuario }
                    : formData;
                onSave(dataToSave);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{user ? 'Editar Usuario' : 'Añadir Nuevo Usuario'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="nombre_usuario" value={formData.nombre_usuario} onChange={handleChange} placeholder="Nombre de usuario" className="p-3 border rounded-lg" required />
                                <input type="password" name="contrasenia" value={formData.contrasenia} onChange={handleChange} placeholder="Contraseña" className="p-3 border rounded-lg" required={!user} />
                                <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} placeholder="Nombre" className="p-3 border rounded-lg" required />
                                <input type="text" name="apellido" value={formData.apellido} onChange={handleChange} placeholder="Apellido" className="p-3 border rounded-lg" required />
                                <input type="email" name="email" value={formData.email} onChange={handleChange} placeholder="Email" className="p-3 border rounded-lg" required />
                                <input type="tel" name="telefono" value={formData.telefono} onChange={handleChange} placeholder="Teléfono" className="p-3 border rounded-lg" required />
                                <select name="rol" value={formData.rol} onChange={handleChange} className="p-3 border rounded-lg md:col-span-2" required>
                                    <option value="" disabled> Seleccione un Rol </option>
                                    <option value="Administrador">Administrador</option>
                                    <option value="Veterinario">Veterinario</option>
                                    <option value="Secretaria">Secretaria</option>
                                    <option value="Empleado">Empleado</option>
                                </select>
                            </div>
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE USUARIOS
        // ---------------------------------

        const UsersPage = ({ data, onSave, onDelete }) => {
            const { users } = data;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const filteredUsers = users.filter(user =>
                Object.values(user).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );

            return (
                <div>
                    {isModalOpen &&
                        <UserModal
                            user={editingUser}
                            onClose={() => { setIsModalOpen(false); setEditingUser(null); }}
                            onSave={onSave}
                        />
                    }
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Panel de Gestión de Usuarios</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    placeholder="Buscar usuario, email, rol..."
                                    className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button
                                onClick={() => { setEditingUser(null); setIsModalOpen(true); }}
                                className="w-full md:w-auto bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 flex items-center justify-center space-x-2"
                            >
                                <i className="fas fa-plus"></i>
                                <span>Añadir Usuario</span>
                            </button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-4 font-semibold text-gray-600">Usuario</th>
                                        <th className="p-4 font-semibold text-gray-600">Nombre</th>
                                        <th className="p-4 font-semibold text-gray-600">Email</th>
                                        <th className="p-4 font-semibold text-gray-600">Teléfono</th>
                                        <th className="p-4 font-semibold text-gray-600">Rol</th>
                                        <th className="p-4 font-semibold text-gray-600 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredUsers.map(user => (
                                        <tr key={user.id_usuario} className="border-b hover:bg-gray-50">
                                            <td className="p-4">{user.nombre_usuario}</td>
                                            <td className="p-4">{user.nombre} {user.apellido}</td>
                                            <td className="p-4">{user.email}</td>
                                            <td className="p-4">{user.telefono}</td>
                                            <td className="p-4">{user.rol}</td>
                                            <td className="p-4 text-center">
                                                <button
                                                    onClick={() => { setEditingUser(user); setIsModalOpen(true); }}
                                                    className="text-blue-500 hover:text-blue-700 p-2"
                                                    title="Editar"
                                                >
                                                    <i className="fas fa-edit fa-lg"></i>
                                                </button>
                                                <button
                                                    onClick={() => onDelete(user.id_usuario)}
                                                    className="text-red-500 hover:text-red-700 p-2"
                                                    title="Eliminar"
                                                >
                                                    <i className="fas fa-trash-alt fa-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredUsers.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-user fa-3x mb-4"></i>
                                <p className="font-semibold">No se encontraron usuarios</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ----------------------------
        // MODAL PARA VETERINARIOS
        // ----------------------------

        const VetModal = ({ vet, usuarios, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                nombre: vet?.nombre || '',
                apellido: vet?.apellido || '',
                especialidad: vet?.especialidad || '',
                telefono: vet?.telefono || '',
                email: vet?.email || '',
                id_usuario: vet?.id_usuario || ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = vet?.id_veterinario
                    ? { ...formData, id_veterinario: vet.id_veterinario }
                    : formData;
                onSave(dataToSave);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{vet ? 'Editar Veterinario' : 'Añadir Nuevo Veterinario'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} placeholder="Nombre" className="p-3 border rounded-lg" required />
                                <input type="text" name="apellido" value={formData.apellido} onChange={handleChange} placeholder="Apellido" className="p-3 border rounded-lg" required />
                                <input type="text" name="especialidad" value={formData.especialidad} onChange={handleChange} placeholder="Especialidad" className="p-3 border rounded-lg" required />
                                <input type="tel" name="telefono" value={formData.telefono} onChange={handleChange} placeholder="Teléfono" className="p-3 border rounded-lg" required />
                                <input type="email" name="email" value={formData.email} onChange={handleChange} placeholder="Email" className="p-3 border rounded-lg" required />
                                <select name="id_usuario" value={formData.id_usuario} onChange={handleChange} className="p-3 border rounded-lg md:col-span-2" required>
                                    <option value="" disabled> Seleccione un Usuario </option>
                                    {usuarios.map(usuario => (
                                        <option key={usuario.id_usuario} value={usuario.id_usuario}>
                                            {usuario.nombre_usuario}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE VETERINARIOS
        // ---------------------------------

        const VetsPage = ({ vets, usuarios, onSave, onDelete }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingVet, setEditingVet] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const filteredVets = vets.filter(vet =>
                Object.values(vet).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );

            return (
                <div>
                    {isModalOpen && (
                        <VetModal
                            vet={editingVet}
                            usuarios={usuarios}
                            onClose={() => { setIsModalOpen(false); setEditingVet(null); }}
                            onSave={onSave}
                        />
                    )}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Panel de Gestión de Veterinarios</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    placeholder="Buscar veterinario, especialidad..."
                                    className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button
                                onClick={() => { setEditingVet(null); setIsModalOpen(true); }}
                                className="w-full md:w-auto bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 flex items-center justify-center space-x-2"
                            >
                                <i className="fas fa-plus"></i>
                                <span>Añadir Veterinario</span>
                            </button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-4 font-semibold text-gray-600">Nombre</th>
                                        <th className="p-4 font-semibold text-gray-600">Especialidad</th>
                                        <th className="p-4 font-semibold text-gray-600">Teléfono</th>
                                        <th className="p-4 font-semibold text-gray-600">Email</th>
                                        <th className="p-4 font-semibold text-gray-600">Usuario</th>
                                        <th className="p-4 font-semibold text-gray-600 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredVets.map(vet => (
                                        <tr key={vet.id_veterinario} className="border-b hover:bg-gray-50">
                                            <td className="p-4">{vet.nombre_veterinario} {vet.apellido_veterinario}</td>
                                            <td className="p-4">{vet.especialidad_veterinario}</td>
                                            <td className="p-4">{vet.telefono_veterinario}</td>
                                            <td className="p-4">{vet.email_veterinario}</td>
                                            <td className="p-4">{vet.nombre_usuario}</td>
                                            <td className="p-4 text-center">
                                                <button
                                                    onClick={() => { setEditingVet(vet); setIsModalOpen(true); }}
                                                    className="text-blue-500 hover:text-blue-700 p-2"
                                                    title="Editar"
                                                >
                                                    <i className="fas fa-edit fa-lg"></i>
                                                </button>
                                                <button
                                                    onClick={() => onDelete(vet.id_veterinario)}
                                                    className="text-red-500 hover:text-red-700 p-2"
                                                    title="Eliminar"
                                                >
                                                    <i className="fas fa-trash-alt fa-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredVets.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-user-md fa-3x mb-4"></i>
                                <p className="font-semibold">No se encontraron veterinarios</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ----------------------------
        // MODAL PARA CITAS
        // ----------------------------

        const AppointmentModal = ({ appointment, pets, vets, onClose, onSave }) => {
            const [formData, setFormData] = useState(
                {
                    fecha: appointment?.fecha ? new Date(appointment.fecha).toISOString().split('T')[0] : '',
                    hora: appointment?.hora || '',
                    id_mascota: appointment?.id_mascota || '',
                    id_veterinario: appointment?.id_veterinario || '',
                    motivo: appointment?.motivo || '',
                });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = appointment?.id_cita
                    ? { ...formData, id_cita: appointment.id_cita }
                    : formData;
                onSave(dataToSave);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{appointment ? 'Editar Cita' : 'Agendar Nueva Cita'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="date" name="fecha" value={formData.fecha} onChange={handleChange} className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <input type="time" name="hora" value={formData.hora} onChange={handleChange} className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <select name="id_mascota" value={formData.id_mascota} onChange={handleChange} className="p-3 border rounded-lg md:col-span-2 focus:ring-2 focus:ring-orange-400 focus:outline-none bg-white" required>
                                    <option value="" disabled> Seleccione una Mascota </option>
                                    {pets.map(pet => (
                                        <option key={pet.id_mascota} value={pet.id_mascota}>
                                            {pet.nombre} ({pet.nombre_cliente})
                                        </option>
                                    ))}
                                </select>
                                <input type="number" name="id_veterinario" value={formData.id_veterinario} onChange={handleChange} placeholder="ID del Veterinario" className="p-3 border rounded-lg md:col-span-2 focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <textarea name="motivo" value={formData.motivo} onChange={handleChange} placeholder="Motivo de la consulta" className="p-3 border rounded-lg md:col-span-2 focus:ring-2 focus:ring-orange-400 focus:outline-none" rows="3" required></textarea>
                            </div>
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE CITAS
        // ---------------------------------

        const AppointmentsPage = ({ data, onSave, onDelete }) => {
            const { appointments, pets, vets } = data;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingAppointment, setEditingAppointment] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const filteredAppointments = appointments.filter(appointment => Object.values(appointment).some(value => String(value).toLowerCase().includes(searchTerm.toLowerCase())));
            return (
                <div>
                    {isModalOpen && (
                        <AppointmentModal
                            appointment={editingAppointment}
                            pets={pets}
                            vets={vets}
                            onClose={() => { setIsModalOpen(false); setEditingAppointment(null); }}
                            onSave={onSave}
                        />
                    )}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Panel de Gestión de Citas</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" placeholder="Buscar cita, mascota, veterinario..." className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            </div>
                            <button onClick={() => { setEditingAppointment(null); setIsModalOpen(true); }} className="bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 flex items-center justify-center space-x-2">
                                <i className="fas fa-plus"></i>
                                <span>Agendar Cita</span>
                            </button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-4 font-semibold text-gray-600">Fecha y Hora</th>
                                        <th className="p-4 font-semibold text-gray-600">Paciente</th>
                                        <th className="p-4 font-semibold text-gray-600">Veterinario</th>
                                        <th className="p-4 font-semibold text-gray-600">Motivo</th>
                                        <th className="p-4 font-semibold text-gray-600 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredAppointments.map(appointment => (
                                        <tr key={appointment.id_cita} className="border-b hover:bg-gray-50">
                                            <td className="p-4">
                                                <div className="font-semibold text-gray-800">{new Date(appointment.fecha).toLocaleDateString()}</div>
                                                <div className="text-sm text-gray-500">{appointment.hora}</div>
                                            </td>
                                            <td className="p-4">
                                                <div className="font-semibold text-gray-800">{appointment.nombre_mascota}</div>
                                                <div className="text-sm text-gray-500">{appointment.nombre_cliente}</div>
                                            </td>
                                            <td className="p-4 text-gray-700">{appointment.nombre_veterinario}</td>
                                            <td className="p-4 text-gray-700">{appointment.motivo}</td>
                                            <td className="p-4 text-center">
                                                <button onClick={() => { setEditingAppointment(appointment); setIsModalOpen(true); }} className="text-blue-500 hover:text-blue-700 p-2" title="Editar">
                                                    <i className="fas fa-edit fa-lg"></i>
                                                </button>
                                                <button onClick={() => onDelete(appointment.id_cita)} className="text-red-500 hover:text-red-700 p-2" title="Eliminar">
                                                    <i className="fas fa-trash-alt fa-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {appointments.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-calendar-check fa-3x mb-4"></i>
                                <p className="font-semibold">No hay citas programadas</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ----------------------------
        // MODAL PARA FACTURACIÓN
        // ----------------------------

        const BillingModal = ({ factura, clientes, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                fecha_emision: factura?.fecha_emision ? new Date(factura.fecha_emision).toISOString().split('T')[0] : '',
                total: factura?.total || '',
                metodo_pago: factura?.metodo_pago || '',
                id_cliente: factura?.id_cliente || ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = factura?.id_factura
                    ? { ...formData, id_factura: factura.id_factura }
                    : formData;
                onSave(dataToSave);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">
                            {factura ? 'Editar Factura' : 'Añadir Nueva Factura'}
                        </h2>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="date" name="fecha_emision" value={formData.fecha_emision} onChange={handleChange} className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <input type="number" name="total" value={formData.total} onChange={handleChange} placeholder="Total" className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" required />
                                <select name="metodo_pago" value={formData.metodo_pago} onChange={handleChange} className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none bg-white" required >
                                    <option value="" disabled> Método de Pago </option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Transferencia">Transferencia</option>
                                </select>
                                <select name="id_cliente" value={formData.id_cliente} onChange={handleChange} className="p-3 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none bg-white" required >
                                    <option value="" disabled> Seleccione un Cliente </option>
                                    {clientes.map(cliente => (
                                        <option key={cliente.id_cliente} value={cliente.id_cliente}>
                                            {cliente.nombre} {cliente.apellido}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE FACTURACIÓN
        // ---------------------------------

        const BillingPage = ({ data, onSave, onDelete }) => {
            const { billing, clients } = data;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingBill, setEditingBill] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const filteredBilling = billing.filter(bill =>
                Object.values(bill).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );

            const getPaymentMethodStyle = (method) => {
                const styles = { Efectivo: 'bg-green-100 text-green-800', Tarjeta: 'bg-indigo-100 text-indigo-800', Transferencia: 'bg-sky-100 text-sky-800' };
                return styles[method] || 'bg-gray-100 text-gray-800';
            };

            const handleAdd = () => { setEditingBill(null); setIsModalOpen(true); };
            const handleEdit = (bill) => { setEditingBill(bill); setIsModalOpen(true); };
            const handleCloseModal = () => { setIsModalOpen(false); setEditingBill(null); };

            return (
                <div>
                    {isModalOpen && (
                        <BillingModal
                            factura={editingBill}
                            clientes={clients}
                            onClose={handleCloseModal}
                            onSave={(data) => { onSave(data); handleCloseModal(); }}
                        />
                    )}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Historial de Facturación</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    placeholder="Buscar factura, cliente, método de pago..."
                                    className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button
                                onClick={handleAdd}
                                className="bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 flex items-center space-x-2"
                            >
                                <i className="fas fa-plus"></i>
                                <span>Añadir Factura</span>
                            </button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-4 font-semibold text-gray-600">Factura #</th>
                                        <th className="p-4 font-semibold text-gray-600">Cliente</th>
                                        <th className="p-4 font-semibold text-gray-600">Fecha</th>
                                        <th className="p-4 font-semibold text-gray-600 text-center">Método de Pago</th>
                                        <th className="p-4 font-semibold text-gray-600 text-right">Total</th>
                                        <th className="p-4 font-semibold text-gray-600 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredBilling.map(bill => (
                                        <tr key={bill.id_factura} className="border-b hover:bg-gray-50">
                                            <td className="p-4 font-mono text-gray-600">{String(bill.id_factura).padStart(5, '0')}</td>
                                            <td className="p-4 font-semibold text-gray-800">{bill.nombre_cliente}</td>
                                            <td className="p-4 text-gray-700">{new Date(bill.fecha_emision).toLocaleDateString()}</td>
                                            <td className="p-4 text-center">
                                                <span className={`px-3 py-1 text-sm font-medium rounded-full ${getPaymentMethodStyle(bill.metodo_pago)}`}>{bill.metodo_pago}</span>
                                            </td>
                                            <td className="p-4 text-right font-semibold text-gray-800">${new Intl.NumberFormat('es-CO').format(bill.total)}</td>
                                            <td className="p-4 text-center">
                                                <button
                                                    onClick={() => handleEdit(bill)}
                                                    className="text-blue-500 hover:text-blue-700 p-2"
                                                    title="Editar"
                                                >
                                                    <i className="fas fa-edit fa-lg"></i>
                                                </button>
                                                <button
                                                    onClick={() => onDelete(bill.id_factura)}
                                                    className="text-red-500 hover:text-red-700 p-2"
                                                    title="Eliminar"
                                                >
                                                    <i className="fas fa-trash-alt fa-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {billing.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-file-invoice-dollar fa-3x mb-4"></i>
                                <p className="font-semibold">No hay facturas emitidas</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ----------------------------
        // MODAL PARA BARRIOS
        // ----------------------------

        const BarrioModal = ({ barrio, localidades, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                nombre: barrio?.nombre_barrio || '',
                id_localidad: barrio?.id_localidad || ''
            });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = barrio?.id_barrio
                    ? { ...formData, id_barrio: barrio.id_barrio }
                    : formData;
                onSave(dataToSave);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{barrio ? 'Editar Barrio' : 'Añadir Barrio'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 gap-4">
                                <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} placeholder="Nombre del barrio" className="p-3 border rounded-lg" required />
                                <select name="id_localidad" value={formData.id_localidad} onChange={handleChange} className="p-3 border rounded-lg" required>
                                    <option value="" disabled>Seleccione una Localidad</option>
                                    {localidades.map(loc => (
                                        <option key={loc.id_localidad} value={loc.id_localidad}>{loc.nombre_localidad}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE BARRIOS
        // ---------------------------------

        const BarriosPage = ({ barrios, localidades, onSave, onDelete }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingBarrio, setEditingBarrio] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const filteredBarrios = barrios.filter(barrio =>
                Object.values(barrio).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );
            return (
                <div>
                    {isModalOpen && (
                        <BarrioModal
                            barrio={editingBarrio}
                            localidades={localidades}
                            onClose={() => { setIsModalOpen(false); setEditingBarrio(null); }}
                            onSave={onSave}
                        />
                    )}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Panel de Gestión de Barrios</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    placeholder="Buscar barrio, localidad..."
                                    className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button onClick={() => { setEditingBarrio(null); setIsModalOpen(true); }} className="bg-orange-500 text-white py-2 px-6 rounded-lg">Añadir Barrio</button>
                        </div>
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4">Barrio</th>
                                    <th className="p-4">Localidad</th>
                                    <th className="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredBarrios.map(barrio => (
                                    <tr key={barrio.id_barrio} className="border-b hover:bg-gray-50">
                                        <td className="p-4">{barrio.nombre_barrio}</td>
                                        <td className="p-4">{barrio.nombre_localidad}</td>
                                        <td className="p-4 text-center">
                                            <button
                                                onClick={() => { setEditingBarrio(barrio); setIsModalOpen(true); }}
                                                className="text-blue-500 hover:text-blue-700 p-2"
                                                title="Editar"
                                            >
                                                <i className="fas fa-edit fa-lg"></i>
                                            </button>
                                            <button
                                                onClick={() => onDelete(barrio.id_barrio)}
                                                className="text-red-500 hover:text-red-700 p-2"
                                                title="Eliminar"
                                            >
                                                <i className="fas fa-trash-alt fa-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // ----------------------------
        // MODAL PARA LOCALIDADES
        // ----------------------------

        const LocalidadModal = ({ localidad, onClose, onSave }) => {

            const [formData, setFormData] = useState({
                nombre: localidad?.nombre_localidad || ''
            });
            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = localidad?.id_localidad
                    ? { ...formData, id_localidad: localidad.id_localidad }
                    : { ...formData };
                console.log(dataToSave);
                onSave(dataToSave);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{localidad ? 'Editar Localidad' : 'Añadir Localidad'}</h2>
                        <form onSubmit={handleSubmit}>
                            <input type="text" name="nombre" value={formData.nombre} onChange={(e) => setFormData({ ...formData, nombre: e.target.value })} placeholder="Nombre de la localidad" className="p-3 border rounded-lg w-full" required />
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE LOCALIDADES
        // ---------------------------------

        const LocalidadesPage = ({ data, onSave, onDelete }) => {
            const { localidades } = data;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingLocalidad, setEditingLocalidad] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const filteredLocalidades = localidades.filter(localidad =>
                Object.values(localidad).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );
            return (
                <div>
                    {isModalOpen && (
                        <LocalidadModal
                            localidad={editingLocalidad}
                            onClose={() => { setIsModalOpen(false); setEditingLocalidad(null); }}
                            onSave={onSave}
                        />
                    )}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Panel de Gestión de Localidades</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    placeholder="Buscar localidad..."
                                    className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button onClick={() => { setEditingLocalidad(null); setIsModalOpen(true); }} className="bg-orange-500 text-white py-2 px-6 rounded-lg">
                                <i className="fas fa-plus-circle ml-2"></i>
                                <span>Añadir Localidad</span>
                            </button>
                        </div>
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4 font-semibold text-gray-600">Localidad</th>
                                    <th className="p-4 font-semibold text-gray-600 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredLocalidades.map(localidad => (
                                    <tr key={localidad.id_localidad} className="border-b hover:bg-gray-50">
                                        <td className="p-4 text-gray-700">{localidad.nombre_localidad}</td>
                                        <td className="p-4 text-center">
                                            <button
                                                onClick={() => { setEditingLocalidad(localidad); setIsModalOpen(true); }}
                                                className="text-blue-500 hover:text-blue-700 p-2"
                                                title="Editar"
                                            >
                                                <i className="fas fa-edit fa-lg"></i>
                                            </button>
                                            <button
                                                onClick={() => onDelete(localidad.id_localidad)}
                                                className="text-red-500 hover:text-red-700 p-2"
                                                title="Eliminar"
                                            >
                                                <i className="fas fa-trash-alt fa-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {filteredLocalidades.length === 0 && (
                        <div className="text-center py-10 text-gray-500">
                            <i className="fas fa-users fa-3x mb-4"></i>
                            <p className="font-semibold">No se encontraron localidades</p>
                        </div>
                    )}
                </div>
            );
        };

        // ----------------------------
        // MODAL PARA ENFERMEDADES
        // ----------------------------

        const EnfermedadModal = ({ enfermedad, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                nombre: enfermedad?.nombre_enfermedad || '',
                descripcion: enfermedad?.descripcion_enfermedad || ''
            });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = enfermedad?.id_enfermedad
                    ? { ...formData, id_enfermedad: enfermedad.id_enfermedad }
                    : formData;
                onSave(dataToSave);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{enfermedad ? 'Editar Enfermedad' : 'Añadir Enfermedad'}</h2>
                        <form onSubmit={handleSubmit}>
                            <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} placeholder="Nombre de la enfermedad" className="p-3 border rounded-lg w-full mb-4" required />
                            <textarea name="descripcion" value={formData.descripcion} onChange={handleChange} placeholder="Descripción" className="p-3 border rounded-lg w-full" required />
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ---------------------------------
        // PÁGINA DE GESTIÓN DE ENFERMEDADES
        // ---------------------------------

        const EnfermedadesPage = ({ enfermedades, onSave, onDelete }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEnfermedad, setEditingEnfermedad] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const filteredEnfermedades = enfermedades.filter(enf =>
                Object.values(enf).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );
            return (
                <div>
                    {isModalOpen && (
                        <EnfermedadModal
                            enfermedad={editingEnfermedad}
                            onClose={() => { setIsModalOpen(false); setEditingEnfermedad(null); }}
                            onSave={onSave}
                        />
                    )}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Gestión de Enfermedades</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    placeholder="Buscar enfermedad..."
                                    className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button onClick={() => { (null); setIsModalOpen(true); }} className="bg-orange-500 text-white py-2 px-6 rounded-lg">Añadir Enfermedad</button>
                        </div>
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4">Nombre</th>
                                    <th className="p-4">Descripción</th>
                                    <th className="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredEnfermedades.map(enf => (
                                    <tr key={enf.id_enfermedad} className="border-b hover:bg-gray-50">
                                        <td className="p-4">{enf.nombre_enfermedad}</td>
                                        <td className="p-4">{enf.descripcion_enfermedad}</td>
                                        <td className="p-4 text-center">
                                            <button
                                                onClick={() => { setEditingEnfermedad(enf), setIsModalOpen(true); }}
                                                className="text-blue-500 hover:text-blue-700 p-2"
                                                title="Editar"
                                            >
                                                <i className="fas fa-edit fa-lg"></i>
                                            </button>
                                            <button
                                                onClick={() => onDelete(enf.id_enfermedad)}
                                                className="text-red-500 hover:text-red-700 p-2"
                                                title="Eliminar"
                                            >
                                                <i className="fas fa-trash-alt fa-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filteredEnfermedades.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-virus fa-3x mb-4"></i>
                                <p className="font-semibold">No se encontraron enfermedades</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --------------------------------------
        // MODAL PARA ENFERMEDADES DE MASCOTAS
        // --------------------------------------

        const EnfermedadMascotaModal = ({ em, mascotas, enfermedades, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                id_mascota: em?.id_mascota || '',
                id_enfermedad: em?.id_enfermedad || '',
                fecha_diagnostico: em?.fecha_diagnostico || ''
            });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = em?.id_enfermedad_mascota
                    ? { ...formData, id_enfermedad_mascota: em.id_enfermedad_mascota }
                    : formData;
                onSave(dataToSave);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{em ? 'Editar Diagnóstico' : 'Añadir Diagnóstico'}</h2>
                        <form onSubmit={handleSubmit}>
                            <select name="id_mascota" value={formData.id_mascota} onChange={handleChange} className="p-3 border rounded-lg w-full mb-4" required>
                                <option value="" disabled>Seleccione Mascota</option>
                                {mascotas.map(m => (
                                    <option key={m.id_mascota} value={m.id_mascota}>{m.nombre}</option>
                                ))}
                            </select>
                            <select name="id_enfermedad" value={formData.id_enfermedad} onChange={handleChange} className="p-3 border rounded-lg w-full mb-4" required>
                                <option value="" disabled>Seleccione Enfermedad</option>
                                {enfermedades.map(e => (
                                    <option key={e.id_enfermedad} value={e.id_enfermedad}>{e.nombre_enfermedad}</option>
                                ))}
                            </select>
                            <input type="date" name="fecha_diagnostico" value={formData.fecha_diagnostico} onChange={handleChange} className="p-3 border rounded-lg w-full" required />
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ------------------------------------------------
        // PÁGINA DE GESTIÓN DE ENFERMEDADES DE MASCOTAS
        // ------------------------------------------------

        const EnfermedadesMascotasPage = ({ enfermedadesMascotas, mascotas, enfermedades, onSave, onDelete }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEM, setEditingEM] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const filteredEM = enfermedadesMascotas.filter(em =>
                Object.values(em).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );
            return (
                <div>
                    {isModalOpen && (
                        <EnfermedadMascotaModal
                            em={editingEM}
                            mascotas={mascotas}
                            enfermedades={enfermedades}
                            onClose={() => { setIsModalOpen(false); setEditingEM(null); }}
                            onSave={onSave}
                        />
                    )}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Diagnóstico de Enfermedades en Mascotas</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    placeholder="Buscar mascota, enfermedad..."
                                    className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button onClick={() => { setEditingEM(null); setIsModalOpen(true); }} className="bg-orange-500 text-white py-2 px-6 rounded-lg">Añadir Diagnóstico</button>
                        </div>
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4">Mascota</th>
                                    <th className="p-4">Enfermedad</th>
                                    <th className="p-4">Fecha Diagnóstico</th>
                                    <th className="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredEM.map(em => (
                                    <tr key={em.id_enfermedad_mascota} className="border-b hover:bg-gray-50">
                                        <td className="p-4">{em.nombre_mascota}</td>
                                        <td className="p-4">{em.nombre_enfermedad}</td>
                                        <td className="p-4">{em.fecha_diagnostico}</td>
                                        <td className="p-4 text-center">
                                            <button
                                                onClick={() => { setEditingEM(em); setIsModalOpen(true); }}
                                                className="text-blue-500 hover:text-blue-700 p-2"
                                                title="Editar"
                                            >
                                                <i className="fas fa-edit fa-lg"></i>
                                            </button>
                                            <button
                                                onClick={() => onDelete(em.id_enfermedad_mascota)}
                                                className="text-red-500 hover:text-red-700 p-2"
                                                title="Eliminar"
                                            >
                                                <i className="fas fa-trash-alt fa-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filteredEM.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-dog fa-3x mb-4"></i>
                                <p className="font-semibold">No se encontraron diagnósticos</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --------------------------------------
        // MODAL PARA SERVICIOS
        // --------------------------------------

        const ServicioModal = ({ servicio, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                nombre: servicio?.nombre_servicio || '',
                descripcion: servicio?.descripcion_servicio || '',
                precio: servicio?.precio_servicio || ''
            });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = servicio?.id_servicio
                    ? { ...formData, id_servicio: servicio.id_servicio }
                    : formData;
                onSave(dataToSave);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{servicio ? 'Editar Servicio' : 'Añadir Servicio'}</h2>
                        <form onSubmit={handleSubmit}>
                            <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} placeholder="Nombre del servicio" className="p-3 border rounded-lg w-full mb-4" required />
                            <textarea name="descripcion" value={formData.descripcion} onChange={handleChange} placeholder="Descripción" className="p-3 border rounded-lg w-full mb-4" required />
                            <input type="number" name="precio" value={formData.precio} onChange={handleChange} placeholder="Precio" className="p-3 border rounded-lg w-full" required />
                            <div className="flex justify-end space-x-4 mt-8">
                                <button type="button" onClick={onClose} className="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                                <button type="submit" className="py-2 px-6 bg-orange-500 text-white rounded-lg">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ------------------------------------------------
        // PÁGINA DE GESTIÓN DE SERVICIOS
        // ------------------------------------------------

        const ServiciosPage = ({ servicios, onSave, onDelete }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingServicio, setEditingServicio] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const filteredServicios = servicios.filter(servicio =>
                Object.values(servicio).some(value =>
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );
            return (
                <div>
                    {isModalOpen && (
                        <ServicioModal
                            servicio={editingServicio}
                            onClose={() => { setIsModalOpen(false); setEditingServicio(null); }}
                            onSave={onSave}
                        />
                    )}
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Gestión de Servicios</h1>
                    </header>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full md:w-1/3">
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input
                                    type="text"
                                    placeholder="Buscar servicio..."
                                    className="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button onClick={() => { setEditingServicio(null); setIsModalOpen(true); }} className="bg-orange-500 text-white py-2 px-6 rounded-lg">Añadir Servicio</button>
                        </div>
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4">Nombre</th>
                                    <th className="p-4">Descripción</th>
                                    <th className="p-4">Precio</th>
                                    <th className="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredServicios.map(servicio => (
                                    <tr key={servicio.id_servicio} className="border-b hover:bg-gray-50">
                                        <td className="p-4">{servicio.nombre_servicio}</td>
                                        <td className="p-4">{servicio.descripcion_servicio}</td>
                                        <td className="p-4">${servicio.precio_servicio}</td>
                                        <td className="p-4 text-center">
                                            <button
                                                onClick={() => { setEditingServicio(servicio); setIsModalOpen(true); }}
                                                className="text-blue-500 hover:text-blue-700 p-2"
                                                title="Editar"
                                            >
                                                <i className="fas fa-edit fa-lg"></i>
                                            </button>
                                            <button
                                                onClick={() => onDelete(servicio.id_servicio)}
                                                className="text-red-500 hover:text-red-700 p-2"
                                                title="Eliminar"
                                            >
                                                <i className="fas fa-trash-alt fa-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filteredServicios.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                <i className="fas fa-concierge-bell fa-3x mb-4"></i>
                                <p className="font-semibold">No se encontraron servicios</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- CONTENEDOR PRINCIPAL DEL DASHBOARD ---
        const DashboardPage = ({ user, onLogout }) => {
            const [activeView, setActiveView] = useState('pets');
            const [data, setData] = useState({ pets: [], clients: [], appointments: [], vets: [], billing: [], users: [], barrios: [], localidades: [], enfermedades: [], enfermedadesMascotas: [], servicios: [], tratamientos: [] /*, detallesFacturas: []*/ });
            const [loading, setLoading] = useState(true);

            const fetchAllData = useCallback(async () => {
                setLoading(true);
                try {
                    const responses = await Promise.all([
                        fetch(`${API_URL}/mascotas`),
                        fetch(`${API_URL}/clientes`),
                        fetch(`${API_URL}/citas`),
                        fetch(`${API_URL}/facturacion`),
                        fetch(`${API_URL}/usuarios`),
                        fetch(`${API_URL}/veterinarios`),
                        fetch(`${API_URL}/barrios`),
                        fetch(`${API_URL}/localidades`),
                        fetch(`${API_URL}/enfermedades`),
                        fetch(`${API_URL}/enfermedades_mascotas`),
                        fetch(`${API_URL}/servicios`),
                        fetch(`${API_URL}/tratamientos`)
                    ]);
                    for (const res of responses) { if (!res.ok) throw new Error('Error al cargar los datos.'); }
                    const [pets, clients, appointments, billing, users, vets, barrios, localidades, enfermedades, enfermedadesMascotas, servicios, tratamientos /*detallesFacturas*/] = await Promise.all(responses.map(res => res.json()));
                    setData({ pets, clients, appointments, billing, users, vets, barrios, localidades, enfermedades, enfermedadesMascotas, servicios, tratamientos /*detallesFacturas*/ });
                } catch (error) { console.error("Error fetching data:", error); alert('No se pudieron cargar los datos.'); }
                finally { setLoading(false); }
            }, []);

            useEffect(() => { fetchAllData(); }, [fetchAllData]);

            const handleSave = async (endpoint, itemData) => {
                console.log(`${endpoint}`)
                let itemDataid;
                let isEditing = false;

                // 1. Intentar con endpoint -2 caracteres
                isEditing = !!itemData[`id_${endpoint.slice(0, -2)}`];
                if (isEditing) {
                    itemDataid = itemData[`id_${endpoint.slice(0, -2)}`];
                } else {
                    // 2. Intentar con endpoint -1 carácter
                    isEditing = !!itemData[`id_${endpoint.slice(0, -1)}`];
                    if (isEditing) {
                        itemDataid = itemData[`id_${endpoint.slice(0, -1)}`];
                    } else {
                        // 3. Intentar con clave original
                        const keyOriginal = `id_${endpoint}`;
                        const keySingular = `id_${endpoint.replace(/([a-z]+)es_([a-z]+)s$/, '$1_$2')}`;
                        console.log(keyOriginal, keySingular);

                        isEditing = !!itemData[keyOriginal];
                        if (isEditing) {
                            itemDataid = itemData[keyOriginal];
                        } else if (keyOriginal !== keySingular) {
                            // 4. Intentar con clave singularizada si es diferente
                            isEditing = !!itemData[keySingular];
                            if (isEditing) {
                                itemDataid = itemData[keySingular];
                            } else {
                                // Ninguna validación pasada, isEditing queda false y itemDataid indefinido
                                isEditing = false;
                                itemDataid = undefined;
                            }
                        } else {
                            // keyOriginal === keySingular y no existe
                            isEditing = false;
                            itemDataid = undefined;
                        }
                    }
                }
                console.log(itemData)
                const url = isEditing ? `${API_URL}/${endpoint}/${itemDataid}` : `${API_URL}/${endpoint}`;
                const method = isEditing ? 'PUT' : 'POST';
                console.log(method)
                try {
                    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(itemData) });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Error al guardar.'); }
                    await fetchAllData();
                } catch (error) { console.error(`Error saving ${endpoint}:`, error); alert(error.message); }
            };

            const handleDelete = async (endpoint, itemId) => {
                if (window.confirm(`¿Estás seguro de que quieres eliminar este elemento?`)) {
                    try {
                        const response = await fetch(`${API_URL}/${endpoint}/${itemId}`, { method: 'DELETE' });
                        if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Error al eliminar.'); }
                        await fetchAllData();
                    } catch (error) { console.error(`Error deleting ${endpoint}:`, error); alert(error.message); }
                }
            };

            const renderActiveView = () => {
                if (loading) return <div className="text-center py-20"><i className="fas fa-spinner fa-spin fa-3x text-orange-500"></i></div>;
                switch (activeView) {
                    case 'pets': return <PetsPage data={data} onSave={(item) => handleSave('mascotas', item)} onDelete={(id) => handleDelete('mascotas', id)} />;
                    case 'clients': return <ClientsPage data={data} onSave={(item) => handleSave('clientes', item)} onDelete={(id) => handleDelete('clientes', id)} />;
                    case 'appointments': return <AppointmentsPage data={data} onSave={(item) => handleSave('citas', item)} onDelete={(id) => handleDelete('citas', id)} />;
                    case 'billing': return <BillingPage data={data} onSave={(item) => handleSave('facturacion', item)} onDelete={(id) => handleDelete('facturacion', id)} />;
                    case 'users': return <UsersPage data={data} onSave={(item) => handleSave('usuarios', item)} onDelete={(id) => handleDelete('usuarios', id)} />;
                    case 'vets': return <VetsPage vets={data.vets} usuarios={data.users} onSave={(item) => handleSave('veterinarios', item)} onDelete={(id) => handleDelete('veterinarios', id)} />;
                    case 'barrios': return <BarriosPage barrios={data.barrios} localidades={data.localidades} onSave={(item) => handleSave('barrios', item)} onDelete={(id) => handleDelete('barrios', id)} />;
                    case 'localidades': return <LocalidadesPage data={data} onSave={(item) => handleSave('localidades', item)} onDelete={(id) => handleDelete('localidades', id)} />;
                    case 'enfermedades': return <EnfermedadesPage enfermedades={data.enfermedades} onSave={(item) => handleSave('enfermedades', item)} onDelete={(id) => handleDelete('enfermedades', id)} />;
                    case 'enfermedadesMascotas': return <EnfermedadesMascotasPage enfermedadesMascotas={data.enfermedadesMascotas} mascotas={data.pets} enfermedades={data.enfermedades} onSave={(item) => handleSave('enfermedades_mascotas', item)} onDelete={(id) => handleDelete('enfermedades_mascotas', id)} />;
                    case 'servicios': return <ServiciosPage servicios={data.servicios} onSave={(item) => handleSave('servicios', item)} onDelete={(id) => handleDelete('servicios', id)} />;
                    default: return <PetsPage data={data} />;
                }
            };

            const NavLink = ({ view, icon, children }) => (
                <a href="#" onClick={(e) => { e.preventDefault(); setActiveView(view); }} className={`flex items-center p-3 rounded-lg transition-colors ${activeView === view ? 'bg-orange-100 text-gray-900 font-semibold' : 'text-gray-600 hover:bg-gray-100'}`}>
                    <i className={`fas ${icon} w-6 ${activeView === view ? 'text-orange-500' : ''}`}></i><span>{children}</span>
                </a>
            );

            return (<div className="min-h-screen bg-slate-50 flex">
                <aside className="w-64 bg-white shadow-md flex flex-col flex-shrink-0"><div className="p-6 flex items-center space-x-3 border-b"><img src="Imagenes/logo_fondo_claro.png" alt="Logo Wapoki" className="h-10 w-10 rounded-full" /><span className="text-2xl font-bold text-orange-500">Wapoki</span></div><nav className="flex-1 p-4 space-y-2">
                    <NavLink view="pets" icon="fa-paw">Mascotas</NavLink>
                    <NavLink view="clients" icon="fa-users">Clientes</NavLink>
                    <NavLink view="appointments" icon="fa-calendar-alt">Citas</NavLink>
                    <NavLink view="billing" icon="fa-file-invoice">Facturación</NavLink>
                    <NavLink view="users" icon="fa-users">Usuarios</NavLink>
                    <NavLink view="vets" icon="fa-user-md">Veterinarios</NavLink>
                    <NavLink view="barrios" icon="fa-map-marker-alt">Barrios</NavLink>
                    <NavLink view="localidades" icon="fa-map-marker-alt">Localidades</NavLink>
                    <NavLink view="enfermedades" icon="fa-medkit">Enfermedades</NavLink>
                    <NavLink view="enfermedadesMascotas" icon="fa-medkit">Enfermedades de Mascotas</NavLink>
                    <NavLink view="servicios" icon="fa-concierge-bell">Servicios</NavLink>
                    {/* <NavLink view="detallesFacturas" icon="fa-file-invoice">Detalles de Facturación</NavLink> */}
                </nav><div className="p-4 border-t"><button onClick={onLogout} className="w-full flex items-center p-3 text-gray-600 hover:bg-red-50 hover:text-red-600 rounded-lg"><i className="fas fa-sign-out-alt w-6"></i><span>Cerrar Sesión</span></button></div></aside>
                <main className="flex-1 p-8 overflow-y-auto">{renderActiveView()}</main>
            </div>);
        };

        // --- COMPONENTE DE LANDING PAGE RESTAURADO ---
        const LandingPage = ({ onNavigate }) => {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const handleScrollTo = (e, selector) => {
                e.preventDefault();
                const element = document.querySelector(selector);
                if (element) { element.scrollIntoView({ behavior: 'smooth' }); }
                setIsMenuOpen(false);
            };
            return (<div>
                <header className="bg-white shadow-md sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
                        <a href="#" onClick={(e) => handleScrollTo(e, 'body')} className="flex items-center space-x-3 min-w-0">
                            <img src="Imagenes/logo_fondo_claro.png" alt="Logo Wapoki" className="h-10 w-10 rounded-full" />
                            <span className="text-3xl font-bold text-orange-500 truncate">Wapoki</span>
                        </a>
                        <nav className="hidden md:flex space-x-6 items-center">
                            <a href="#quienes-somos" onClick={(e) => handleScrollTo(e, '#quienes-somos')} className="text-gray-600 hover:text-orange-500">¿Quiénes somos?</a>
                            <a href="#objetivos" onClick={(e) => handleScrollTo(e, '#objetivos')} className="text-gray-600 hover:text-orange-500">Objetivos</a>
                            <a href="#servicios" onClick={(e) => handleScrollTo(e, '#servicios')} className="text-gray-600 hover:text-orange-500">Servicios</a>
                            <a href="#contacto-footer" onClick={(e) => handleScrollTo(e, '#contacto-footer')} className="text-gray-600 hover:text-orange-500">Contacto</a>
                        </nav>
                        <div className="hidden md:flex space-x-3 items-center">
                            <button onClick={() => onNavigate('login')} className="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg">Iniciar sesión</button>
                            <button onClick={() => onNavigate('register')} className="border border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-white font-semibold py-2 px-4 rounded-lg">Registrarse</button>
                        </div>
                        <div className="md:hidden"><button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-gray-600 hover:text-orange-500"><i className="fas fa-bars fa-lg"></i></button></div>
                    </div>
                    {isMenuOpen && (<div className="md:hidden bg-white shadow-lg"><a href="#quienes-somos" onClick={(e) => handleScrollTo(e, '#quienes-somos')} className="block px-6 py-3 text-gray-600 hover:bg-orange-50">¿Quiénes somos?</a><a href="#objetivos" onClick={(e) => handleScrollTo(e, '#objetivos')} className="block px-6 py-3 text-gray-600 hover:bg-orange-50">Objetivos</a><a href="#servicios" onClick={(e) => handleScrollTo(e, '#servicios')} className="block px-6 py-3 text-gray-600 hover:bg-orange-50">Servicios</a><a href="#contacto-footer" onClick={(e) => handleScrollTo(e, '#contacto-footer')} className="block px-6 py-3 text-gray-600 hover:bg-orange-50">Contacto</a><div className="px-6 py-3 border-t"><button onClick={() => onNavigate('login')} className="block w-full text-center bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg mb-2">Iniciar sesión</button><button onClick={() => onNavigate('register')} className="block w-full text-center border border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-white font-semibold py-2 px-4 rounded-lg">Registrarse</button></div></div>)}
                </header>
                <main>
                    <section className="hero-section-diagonal"><div className="hero-image-strip-diagonal" style={{ backgroundImage: "url('Imagenes/perro.jpg')" }}></div><div className="hero-image-strip-diagonal" style={{ backgroundImage: "url('Imagenes/gato.jpg')" }}></div><div className="hero-image-strip-diagonal" style={{ backgroundImage: "url('Imagenes/hamster.jpg')" }}></div><div className="hero-image-strip-diagonal" style={{ backgroundImage: "url('Imagenes/conejo.jpg')" }}></div><div className="hero-image-strip-diagonal" style={{ backgroundImage: "url('Imagenes/perro_2.jpg')" }}></div></section>
                    <section id="quienes-somos" className="py-16 bg-white"><div className="container mx-auto px-6 text-center"><h1 className="text-4xl font-bold text-gray-800 mb-6">Bienvenido a <span className="gradient-text">Wapoki</span></h1><p className="text-lg text-gray-600 mb-8 max-w-3xl mx-auto">En Wapoki, amamos a los animales tanto como tú. Somos un equipo de profesionales dedicados al cuidado de tus mascotas, ofreciendo servicios veterinarios en un ambiente cálido y amigable.</p><div className="grid md:grid-cols-2 gap-8 items-center"><div className="text-left"><h2 className="text-2xl font-semibold text-orange-500 mb-4">Nuestra Misión</h2><p className="text-gray-600 mb-4">Proporcionar atención veterinaria excepcional y compasiva, promoviendo la salud y el bienestar de las mascotas y fortaleciendo el vínculo especial que comparten con sus familias. Buscamos ser un referente en Bogotá, conectando veterinarios y facilitando el acceso a historiales clínicos.</p><h2 className="text-2xl font-semibold text-orange-500 mb-4">Nuestra Visión</h2><p className="text-gray-600">Ser la clínica veterinaria líder en innovación y cuidado animal, reconocida por nuestra excelencia profesional, trato ético y compromiso con la comunidad y sus mascotas.</p></div><div><img src="Imagenes/equipo.jpg" alt="Equipo veterinario Wapoki" className="rounded-lg shadow-xl mx-auto w-64 h-64 object-cover" /></div></div></div></section>
                    <section id="objetivos" className="py-16 bg-orange-50"><div className="container mx-auto px-6"><h2 className="text-3xl font-bold text-center text-orange-600 mb-10">Nuestros Objetivos</h2><div className="grid md:grid-cols-3 gap-8 text-center"><div className="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300"><div className="text-orange-500 mb-4"><i className="fas fa-heartbeat fa-3x"></i></div><h3 className="text-xl font-semibold text-gray-700 mb-2">Bienestar Animal</h3><p className="text-gray-600">Garantizar la salud y felicidad de cada mascota que nos visita a través de medicina preventiva y tratamientos efectivos.</p></div><div className="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300"><div className="text-orange-500 mb-4"><i className="fas fa-users fa-3x"></i></div><h3 className="text-xl font-semibold text-gray-700 mb-2">Confianza del Cliente</h3><p className="text-gray-600">Construir relaciones duraderas con nuestros clientes basadas en la transparencia, comunicación y un servicio excepcional.</p></div><div className="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300"><div className="text-orange-500 mb-4"><i className="fas fa-notes-medical fa-3x"></i></div><h3 className="text-xl font-semibold text-gray-700 mb-2">Historias Clínicas Digitales</h3><p className="text-gray-600">Implementar y facilitar el acceso a historiales clínicos digitales para una atención coordinada y eficiente.</p></div></div></div></section>
                    <section id="servicios" className="py-16 bg-white"><div className="container mx-auto px-6"><h2 className="text-3xl font-bold text-center text-gray-800 mb-10">Nuestros Servicios</h2><div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-8">{[{ icon: 'fa-stethoscope', title: 'Consultas Generales', desc: 'Atención médica completa para el diagnóstico y tratamiento.' }, { icon: 'fa-syringe', title: 'Vacunación', desc: 'Planes de vacunación personalizados para proteger a tu mascota.' }, { icon: 'fa-cut', title: 'Cirugías', desc: 'Procedimientos quirúrgicos con equipos modernos y cualificados.' }, { icon: 'fa-dog', title: 'Peluquería y Spa', desc: 'Servicios para que tu mascota luzca y se sienta genial.' }].map(service => (<div key={service.title} className="bg-gray-50 p-6 rounded-lg shadow-md text-center hover:shadow-lg transition-shadow duration-300"><div className="text-orange-500 mb-4"><i className={`fas ${service.icon} fa-3x`}></i></div><h3 className="text-xl font-semibold text-gray-700 mb-2">{service.title}</h3><p className="text-gray-600 text-sm">{service.desc}</p></div>))}</div></div></section>
                    <section className="py-16 bg-orange-50"><div className="container mx-auto px-6"><h2 className="text-3xl font-bold text-center text-orange-600 mb-10">Lo que Dicen Nuestros Clientes</h2><div className="grid md:grid-cols-2 gap-8"><div className="bg-white p-8 rounded-lg shadow-lg"><p className="text-gray-600 italic mb-4">"La veterinaria Wapoki atendió a mi perro Buñuelo con mucho cariño y profesionalismo. ¡Estamos muy agradecidos por su excelente atención!"</p><p className="text-gray-800 font-semibold">- Tatiana y Buñuelo</p></div><div className="bg-white p-8 rounded-lg shadow-lg"><p className="text-gray-600 italic mb-4">"Wapoki es mi veterinaria de confianza, mis gatos están más sanos y felices. Sus servicios son de primera y el personal es increíblemente amable."</p><p className="text-gray-800 font-semibold">- Carlos, Michoso y Oreo</p></div></div></div></section>
                    <section className="py-20 bg-orange-500"><div className="container mx-auto px-6 text-center"><h2 className="text-3xl font-bold text-white mb-6">¿Listo para darle a tu mascota el mejor cuidado?</h2><p className="text-orange-100 text-lg mb-8 max-w-2xl mx-auto">Agenda una cita hoy mismo o contáctanos para más información. En Wapoki, tu mascota está en las mejores manos.</p><a href="#contacto-footer" onClick={(e) => handleScrollTo(e, '#contacto-footer')} className="bg-white text-orange-500 font-bold py-3 px-8 rounded-lg hover:bg-orange-100 transition duration-300 text-lg shadow-md">Agendar Cita</a></div></section>
                </main>
                <footer id="contacto-footer" className="bg-gray-700 text-gray-300 py-12">
                    <div className="container mx-auto px-6"><div className="grid md:grid-cols-3 gap-8 items-start"><div className="mb-6 md:mb-0"><a href="#" onClick={(e) => handleScrollTo(e, 'body')} className="flex items-center space-x-3 text-3xl font-bold text-orange-400 mb-4"><img src="Imagenes/logo_fondo_oscuro.png" alt="Logo Wapoki Footer" className="h-10 w-10 rounded-full" /><span>Wapoki</span></a><h4 className="text-xl font-semibold text-white mb-3 mt-2">Sobre Nosotros</h4><p className="text-sm">Buscamos poder conectar todos los veterinarios de Bogotá para empezar a generar historias clínicas para tus mascotas.</p></div><div><h4 className="text-xl font-semibold text-white mb-3">Contactos</h4><ul className="space-y-2 text-sm"><li><i className="fas fa-phone-alt mr-2 text-orange-400"></i><a href="tel:+573143772885" className="hover:text-orange-400">314 377 2885</a></li><li><i className="fas fa-envelope mr-2 text-orange-400"></i><a href="mailto:tatianquina10@gmail.com" className="hover:text-orange-400">tatianquina10@gmail.com</a></li><li><i className="fas fa-map-marker-alt mr-2 text-orange-400"></i>Bogotá, Colombia. Cl. 84 #24 - 78</li></ul></div><div><h4 className="text-xl font-semibold text-white mb-3">Redes Sociales</h4><ul className="space-y-2 text-sm"><li><i className="fab fa-instagram mr-2 text-orange-400"></i><a href="https://www.instagram.com/_tatiana_pulido_/" target="_blank" rel="noopener" className="hover:text-orange-400">@_tatiana_pulido_</a></li><li><i className="fab fa-facebook-f mr-2 text-orange-400"></i><a href="https://www.facebook.com/leiidytatiana07/?locale=es_LA" target="_blank" rel="noopener" className="hover:text-orange-400">/wapokipet</a></li><li><i className="fab fa-whatsapp mr-2 text-orange-400"></i><a href="https://wa.me/573143772885" target="_blank" rel="noopener" className="hover:text-orange-400">WhatsApp (+57 314 377 2885)</a></li></ul></div></div><div className="mt-10 border-t border-gray-600 pt-8 text-center text-sm"><p>&copy; {new Date().getFullYear()} Veterinaria Wapoki. Todos los derechos reservados.</p><p>Diseñado con <i className="fas fa-heart text-orange-400"></i> por el equipo Wapoki.</p></div></div>
                </footer>
            </div>);
        };
        const LoginPage = ({ onLogin, onNavigate }) => {
            const [formData, setFormData] = useState({
                nombre_usuario: '',
                contrasenia: ''
            });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                setError(''); // Limpiar error al escribir
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const response = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Guardar el token en localStorage
                        localStorage.setItem('wapokiToken', data.token);
                        onLogin(data.user);
                    } else {
                        setError(data.error || 'Error al iniciar sesión');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setError('Error de conexión. Intenta de nuevo.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-orange-50 p-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-2xl p-8 lg:p-12 fade-in">
                        <div className="text-center mb-8">
                            <img src="Imagenes/logo_fondo_claro.png" alt="Logo Wapoki" className="h-20 w-20 rounded-full mx-auto mb-4" />
                            <h1 className="text-3xl font-bold text-gray-800">Bienvenido de Nuevo</h1>
                            <p className="text-gray-500 mt-2">Inicia sesión para gestionar la clínica.</p>
                        </div>
                        
                        {error && (
                            <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                                {error}
                            </div>
                        )}
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="text-sm font-semibold text-gray-600">Usuario</label>
                                <input 
                                    type="text" 
                                    name="nombre_usuario"
                                    value={formData.nombre_usuario}
                                    onChange={handleChange}
                                    className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                    placeholder="Nombre de usuario" 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-sm font-semibold text-gray-600">Contraseña</label>
                                <input 
                                    type="password" 
                                    name="contrasenia"
                                    value={formData.contrasenia}
                                    onChange={handleChange}
                                    className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                    placeholder="********" 
                                    required 
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition-colors text-lg disabled:opacity-50"
                            >
                                {loading ? 'Iniciando sesión...' : 'Iniciar Sesión'}
                            </button>
                        </form>
                        <p className="text-center text-sm text-gray-500 mt-8">
                            ¿No tienes cuenta? 
                            <button onClick={() => onNavigate('register')} className="font-semibold text-orange-500 hover:underline ml-1">
                                Regístrate aquí
                            </button>
                        </p>
                        <p className="text-center text-sm text-gray-500 mt-2">
                            <button onClick={() => onNavigate('landing')} className="hover:underline">
                                Volver al inicio
                            </button>
                        </p>
                    </div>
                </div>
            );
        };
        const RegisterPage = ({ onRegister, onNavigate }) => {
            const [formData, setFormData] = useState({
                nombre_usuario: '',
                contrasenia: '',
                confirmarContrasenia: '',
                nombre: '',
                apellido: '',
                email: '',
                telefono: '',
                rol: 'cliente'
            });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                setError(''); // Limpiar error al escribir
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                // Validar que las contraseñas coincidan
                if (formData.contrasenia !== formData.confirmarContrasenia) {
                    setError('Las contraseñas no coinciden');
                    setLoading(false);
                    return;
                }

                // Validar longitud de contraseña
                if (formData.contrasenia.length < 6) {
                    setError('La contraseña debe tener al menos 6 caracteres');
                    setLoading(false);
                    return;
                }

                try {
                    const { confirmarContrasenia, ...dataToSend } = formData;
                    
                    const response = await fetch(`${API_URL}/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dataToSend),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Guardar el token en localStorage
                        localStorage.setItem('wapokiToken', data.token);
                        onRegister(data.user);
                    } else {
                        setError(data.error || 'Error al registrar usuario');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setError('Error de conexión. Intenta de nuevo.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-orange-50 p-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-2xl p-8 lg:p-12 fade-in">
                        <div className="text-center mb-8">
                            <img src="Imagenes/logo_fondo_claro.png" alt="Logo Wapoki" className="h-20 w-20 rounded-full mx-auto mb-4" />
                            <h1 className="text-3xl font-bold text-gray-800">Crea tu Cuenta</h1>
                            <p className="text-gray-500 mt-2">Únete a la plataforma Wapoki.</p>
                        </div>
                        
                        {error && (
                            <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                                {error}
                            </div>
                        )}
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-sm font-semibold text-gray-600">Nombre</label>
                                    <input 
                                        type="text" 
                                        name="nombre"
                                        value={formData.nombre}
                                        onChange={handleChange}
                                        className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                        placeholder="Tu nombre" 
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-semibold text-gray-600">Apellido</label>
                                    <input 
                                        type="text" 
                                        name="apellido"
                                        value={formData.apellido}
                                        onChange={handleChange}
                                        className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                        placeholder="Tu apellido" 
                                        required 
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-sm font-semibold text-gray-600">Usuario</label>
                                <input 
                                    type="text" 
                                    name="nombre_usuario"
                                    value={formData.nombre_usuario}
                                    onChange={handleChange}
                                    className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                    placeholder="Nombre de usuario" 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-sm font-semibold text-gray-600">Email</label>
                                <input 
                                    type="email" 
                                    name="email"
                                    value={formData.email}
                                    onChange={handleChange}
                                    className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                    placeholder="tu@email.com" 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-sm font-semibold text-gray-600">Teléfono</label>
                                <input 
                                    type="tel" 
                                    name="telefono"
                                    value={formData.telefono}
                                    onChange={handleChange}
                                    className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                    placeholder="Número de teléfono" 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-sm font-semibold text-gray-600">Contraseña</label>
                                <input 
                                    type="password" 
                                    name="contrasenia"
                                    value={formData.contrasenia}
                                    onChange={handleChange}
                                    className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                    placeholder="Mínimo 6 caracteres" 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-sm font-semibold text-gray-600">Confirmar Contraseña</label>
                                <input 
                                    type="password" 
                                    name="confirmarContrasenia"
                                    value={formData.confirmarContrasenia}
                                    onChange={handleChange}
                                    className="w-full p-3 mt-1 border rounded-lg focus:ring-2 focus:ring-orange-400 focus:outline-none" 
                                    placeholder="Repite tu contraseña" 
                                    required 
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition-colors text-lg disabled:opacity-50"
                            >
                                {loading ? 'Registrando...' : 'Registrarse'}
                            </button>
                        </form>
                        <p className="text-center text-sm text-gray-500 mt-6">
                            ¿Ya tienes una cuenta? 
                            <button onClick={() => onNavigate('login')} className="font-semibold text-orange-500 hover:underline ml-1">
                                Inicia sesión
                            </button>
                        </p>
                        <p className="text-center text-sm text-gray-500 mt-2">
                            <button onClick={() => onNavigate('landing')} className="hover:underline">
                                Volver al inicio
                            </button>
                        </p>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL DE LA APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('landing');
            const [loading, setLoading] = useState(true);

            // Verificar token al cargar la aplicación
            useEffect(() => {
                const verifyToken = async () => {
                    const token = localStorage.getItem('wapokiToken');
                    if (token) {
                        try {
                            const response = await fetch(`${API_URL}/auth/verify`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                },
                            });

                            if (response.ok) {
                                const data = await response.json();
                                setUser(data.user);
                                setCurrentPage('dashboard');
                            } else {
                                // Token inválido, remover del localStorage
                                localStorage.removeItem('wapokiToken');
                                localStorage.removeItem('wapokiUser');
                            }
                        } catch (error) {
                            console.error('Error verificando token:', error);
                            localStorage.removeItem('wapokiToken');
                            localStorage.removeItem('wapokiUser');
                        }
                    }
                    setLoading(false);
                };

                verifyToken();
            }, []);

            // Guarda el usuario en localStorage al iniciar sesión
            const handleLogin = (userData) => {
                setUser(userData);
                localStorage.setItem('wapokiUser', JSON.stringify(userData));
                setCurrentPage('dashboard');
            };

            // Borra el usuario y token de localStorage al cerrar sesión
            const handleLogout = () => {
                setUser(null);
                localStorage.removeItem('wapokiUser');
                localStorage.removeItem('wapokiToken');
                setCurrentPage('landing');
            };

            // Guarda el usuario en localStorage al registrarse
            const handleRegister = (userData) => {
                setUser(userData);
                localStorage.setItem('wapokiUser', JSON.stringify(userData));
                setCurrentPage('dashboard');
            };

            // Mostrar loading mientras se verifica el token
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-orange-50">
                        <div className="text-center">
                            <img src="Imagenes/logo_fondo_claro.png" alt="Logo Wapoki" className="h-20 w-20 rounded-full mx-auto mb-4 animate-pulse" />
                            <p className="text-gray-600">Cargando...</p>
                        </div>
                    </div>
                );
            }

            const renderPage = () => {
                switch (currentPage) {
                    case 'login': return <LoginPage onLogin={handleLogin} onNavigate={setCurrentPage} />;
                    case 'register': return <RegisterPage onRegister={handleRegister} onNavigate={setCurrentPage} />;
                    case 'dashboard': return user ? <DashboardPage user={user} onLogout={handleLogout} /> : <LoginPage onLogin={handleLogin} onNavigate={setCurrentPage} />;
                    default: return <LandingPage onNavigate={setCurrentPage} />;
                }
            };
            return <div>{renderPage()}</div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>